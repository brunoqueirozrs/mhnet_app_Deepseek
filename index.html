<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MHNET Gestor</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004c99">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        body { height: 100dvh; overscroll-behavior-y: none; background-color: #f8fafc; }
        .input-padrao { width: 100%; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 1rem; outline: none; transition: all 0.2s; -webkit-appearance: none; }
        .input-padrao:focus { border-color: #00aeef; box-shadow: 0 0 0 4px rgba(0, 174, 239, 0.1); }
        .label-padrao { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.4rem; display: block; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.5); }
        .progress-bar { transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="text-slate-800 font-sans flex flex-col overflow-hidden select-none">

    <!-- LOGIN -->
    <div id="userMenu" class="fixed inset-0 bg-gradient-to-b from-[#004c99] to-[#003366] z-50 flex flex-col items-center justify-center p-6 fade-in">
        <div class="mb-10 p-6 bg-white/10 rounded-full backdrop-blur-md border border-white/20 shadow-2xl animate-pulse"><i class="fas fa-wifi text-6xl text-white drop-shadow-md"></i></div>
        <div class="bg-white p-8 rounded-[2rem] w-full max-w-sm shadow-2xl relative overflow-hidden">
            <h2 class="text-center text-2xl font-bold text-slate-800 mb-6">Bem-vindo</h2>
            <select id="userSelect" class="w-full p-4 bg-slate-50 rounded-xl border border-gray-200 text-lg outline-none mb-4"><option value="">A carregar...</option></select>
            <button onclick="setLoggedUser()" class="w-full bg-[#00aeef] text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition">ACESSAR SISTEMA</button>
        </div>
        <p class="text-white/30 text-xs mt-8 font-mono">Vers√£o Final V85</p>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="mainContent" class="hidden flex-1 flex flex-col h-full relative">
        <!-- HEADER -->
        <header class="bg-[#004c99] text-white pt-8 pb-4 px-5 shadow-lg flex justify-between items-center z-20 shrink-0 rounded-b-[1.5rem]">
            <div class="flex flex-col justify-center">
                <div class="flex items-center gap-3 mb-1">
                    <img src="https://mhnet.com.br/assets/img/logo_branca.png" class="h-5 opacity-90 object-contain" onerror="this.style.display='none'">
                    <div id="headerDate" class="text-[10px] text-blue-200 font-bold uppercase tracking-wider border-l border-blue-400 pl-3"></div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse shadow-[0_0_5px_rgba(74,222,128,0.8)]"></div>
                    <div id="userInfo" class="text-lg font-bold text-white leading-tight truncate max-w-[220px]">Vendedor</div>
                </div>
            </div>
            <button onclick="logout()" class="w-9 h-9 bg-white/10 rounded-full flex items-center justify-center text-white active:scale-90 transition border border-white/10 shadow-sm"><i class="fas fa-power-off text-xs"></i></button>
        </header>

        <!-- SCROLL AREA -->
        <main id="main-scroll" class="flex-1 overflow-y-auto p-5 pb-36 no-scrollbar scroll-smooth -mt-4 relative z-10">
            
            <!-- DASHBOARD -->
            <div id="dashboard" class="page fade-in">
                
                <!-- PAINEL GESTOR (Admin) -->
                <div id="adminPanel" class="hidden bg-slate-800 p-4 rounded-2xl mb-6 shadow-xl border border-slate-700 animate-in slide-in-from-top-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-user-shield text-yellow-400"></i>
                            <span class="text-xs font-bold text-white uppercase tracking-wider">Modo Gestor</span>
                        </div>
                        <span class="text-[10px] bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded">Vis√£o Global</span>
                    </div>
                    <p class="text-xs text-slate-400">Voc√™ est√° visualizando dados de toda a equipe.</p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                     <!-- Bot√£o Indicadores -->
                    <button onclick="abrirIndicadores()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center gap-2 active:scale-95 transition">
                        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-chart-line"></i></div>
                        <span class="text-xs font-bold text-slate-600">Indicadores</span>
                    </button>
                    <!-- BOT√ÉO TAREFAS -->
                    <button onclick="navegarPara('tarefas')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center gap-2 active:scale-95 transition">
                        <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600"><i class="fas fa-check-square"></i></div>
                        <span class="text-xs font-bold text-slate-600">Tarefas</span>
                    </button>
                </div>

                <div id="listaAtaqueDashboard" class="mb-6 hidden animate-in slide-in-from-top-2"></div>
                
                <div id="lembreteBanner" class="hidden bg-orange-50 border-l-4 border-orange-500 p-4 mb-6 rounded-r-2xl shadow-sm flex items-start gap-4 active:scale-95 transition" onclick="filtrarRetornos()">
                    <div class="bg-orange-100 w-10 h-10 rounded-full flex items-center justify-center text-orange-500 shrink-0"><i class="fas fa-bell"></i></div>
                    <div><p class="font-bold text-orange-800 text-sm">Aten√ß√£o!</p><p id="lembreteTexto" class="text-xs text-orange-600 mt-1">Retornos pendentes.</p></div>
                </div>

                <div class="bg-gradient-to-br from-[#00aeef] to-blue-500 p-5 rounded-2xl shadow-lg shadow-blue-200 text-white flex flex-col items-center justify-center gap-2 active:scale-95 transition cursor-pointer relative overflow-hidden mb-6" onclick="navegarPara('gestaoLeads')">
                     <i class="fas fa-list-ul text-3xl drop-shadow-md"></i>
                     <div class="text-sm uppercase font-bold tracking-wider drop-shadow-md">Minha Carteira de Clientes</div>
                     <div class="text-xs opacity-80"><span id="statLeads">0</span> Leads Hoje</div>
                </div>

                <button onclick="navegarPara('cadastroLead')" class="w-full bg-[#004c99] text-white p-5 rounded-2xl shadow-xl shadow-blue-900/10 font-bold flex items-center justify-between mb-8 active:scale-95 transition group">
                    <div class="flex items-center gap-4"><div class="w-14 h-14 bg-white/10 rounded-2xl flex items-center justify-center border border-white/10"><i class="fas fa-user-plus text-2xl"></i></div><div class="text-left"><div class="text-xs opacity-70 font-medium">A√ß√£o R√°pida</div><div class="text-xl font-bold">Novo Cliente</div></div></div><div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-chevron-right text-xs"></i></div>
                </button>

                <!-- Ferramentas -->
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="navegarPara('materiais')" class="bg-white border border-slate-100 p-4 rounded-2xl shadow-sm flex flex-col items-center gap-3 active:bg-orange-50 transition"><div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center"><i class="fas fa-images"></i></div><span class="text-xs font-bold text-slate-600">Materiais</span></button>
                    <button onclick="navegarPara('objecoes')" class="bg-white border border-slate-100 p-4 rounded-2xl shadow-sm flex flex-col items-center gap-3 active:bg-red-50 transition"><div class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center"><i class="fas fa-shield-alt"></i></div><span class="text-xs font-bold text-slate-600">Obje√ß√µes</span></button>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-6">
                     <button onclick="gerarCoachIA()" class="bg-white border border-slate-100 p-4 rounded-2xl shadow-sm flex flex-col items-center gap-3 active:bg-purple-50 transition"><div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fas fa-brain"></i></div><span class="text-xs font-bold text-slate-600">Coach IA</span></button>
                    <button onclick="consultarPlanosIA()" class="bg-white border border-slate-100 p-4 rounded-2xl shadow-sm flex flex-col items-center gap-3 active:bg-blue-50 transition"><div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fas fa-comments"></i></div><span class="text-xs font-bold text-slate-600">Chat IA</span></button>
                </div>
                
                <!-- BOT√ÉO FALTAS -->
                <button onclick="navegarPara('faltas')" class="w-full bg-white border border-slate-100 p-4 rounded-xl shadow-sm flex items-center justify-center gap-2 active:bg-slate-50 transition text-slate-500 hover:text-slate-700">
                    <i class="fas fa-calendar-times text-red-400"></i><span class="text-xs font-bold uppercase">Solicitar Falta/Justificativa</span>
                </button>
            </div>

            <!-- TELA TAREFAS -->
            <div id="tarefas" class="page hidden fade-in">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <button onclick="navegarPara('dashboard')" class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center text-slate-500 active:scale-90 transition hover:text-[#004c99]"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="text-xl font-bold text-[#004c99]">Minhas Tarefas</h2>
                    </div>
                    <button onclick="abrirModalTarefa()" class="w-10 h-10 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center active:scale-90 transition hover:bg-blue-700"><i class="fas fa-plus"></i></button>
                </div>
                <div id="listaTarefasContainer" class="space-y-3 pb-20">
                    <div class="text-center p-10 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
                </div>
            </div>

            <!-- TELA FALTAS -->
            <div id="faltas" class="page hidden fade-in">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="navegarPara('dashboard')" class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center text-slate-500 active:scale-90 transition hover:text-[#004c99]"><i class="fas fa-arrow-left"></i></button>
                    <h2 class="text-xl font-bold text-[#004c99]">Justificativa</h2>
                </div>
                <div id="formFaltaContainer" class="bg-white p-6 rounded-[1.5rem] shadow-sm border border-slate-100 space-y-5">
                    <button onclick="verHistoricoFaltas()" class="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200 flex items-center justify-center gap-2 mb-2"><i class="fas fa-history"></i> VER HIST√ìRICO</button>
                    <div><label class="label-padrao">Data da Falta/Atraso</label><input type="date" id="faltaData" class="input-padrao"></div>
                    <div><label class="label-padrao">Motivo</label><select id="faltaMotivo" class="input-padrao bg-white"><option value="">Selecione o tipo...</option><option value="FOLGA PROGRAMADA (BANCO DE HORAS)">FOLGA PROGRAMADA (BANCO DE HORAS)</option><option value="CONSULTA M√âDICA">CONSULTA M√âDICA</option><option value="SOLICITA√á√ÉO DE SAIDA EMERGENCIA">SOLICITA√á√ÉO DE SAIDA EMERGENCIA</option><option value="ENCAMINHAMENTO DE ATESTADO">ENCAMINHAMENTO DE ATESTADO</option><option value="ENCAMINHAMENTO DE COMPARECIMENTO">ENCAMINHAMENTO DE COMPARECIMENTO</option><option value="FALTA SEM JUSTIFICATIVA">FALTA SEM JUSTIFICATIVA</option><option value="AJUSTE DE PONTO">AJUSTE DE PONTO</option><option value="BENEF√çCIO - DAY OFF">BENEF√çCIO - DAY OFF</option><option value="PROBLEMAS NO APLICATIVO">PROBLEMAS NO APLICATIVO</option></select></div>
                    <div><label class="label-padrao">Observa√ß√£o / Contexto</label><textarea id="faltaObs" rows="3" class="input-padrao" placeholder="Descreva o ocorrido..."></textarea></div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 border-dashed relative"><label class="label-padrao text-blue-700 mb-2 flex items-center gap-2"><i class="fas fa-paperclip"></i> Anexar Atestado (Foto/PDF)</label><input type="file" id="faltaArquivo" accept="image/*,application/pdf" class="w-full text-xs text-slate-500"><p class="text-[10px] text-slate-400 mt-1">*Obrigat√≥rio para atestados</p></div>
                    <button id="btnEnviarFalta" onclick="enviarJustificativa()" class="w-full bg-[#00aeef] text-white font-bold py-4 rounded-xl shadow-xl mt-4 active:scale-95 transition flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> ENVIAR SOLICITA√á√ÉO</button>
                </div>
                <div id="historicoFaltasContainer" class="hidden mt-4 space-y-3 pb-20"><div class="flex justify-between items-center mb-2 px-2"><h3 class="text-sm font-bold text-slate-500 uppercase">Hist√≥rico</h3><button onclick="ocultarHistoricoFaltas()" class="text-xs text-blue-500 font-bold uppercase">Voltar ao Form</button></div><div id="listaHistoricoFaltas"></div></div>
            </div>

            <!-- TELA INDICADORES -->
            <div id="indicadores" class="page hidden fade-in">
                 <div class="flex items-center gap-4 mb-6"><button onclick="navegarPara('dashboard')" class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center text-slate-500 active:scale-90 transition hover:text-[#004c99]"><i class="fas fa-arrow-left"></i></button><h2 class="text-xl font-bold text-[#004c99]">Meus Indicadores</h2></div>
                 <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 relative overflow-hidden mb-4"><div class="absolute top-0 right-0 p-4 opacity-5"><i class="fas fa-calendar-alt text-6xl text-[#004c99]"></i></div><p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">M√™s Comercial</p><h3 id="indMes" class="text-2xl font-black text-[#004c99] mb-1">--/--</h3><p id="indCiclo" class="text-xs text-slate-500 font-medium">Ciclo: 25 a 24</p></div>
                 <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-blue-50 mb-6"><div class="flex justify-between items-end mb-2"><span class="text-sm font-bold text-slate-600">Minha Meta</span><span id="indMetaTexto" class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">--</span></div><div class="w-full bg-slate-100 rounded-full h-4 mb-6 overflow-hidden border border-slate-200"><div id="indProgresso" class="bg-gradient-to-r from-[#00aeef] to-blue-600 h-4 rounded-full progress-bar shadow-sm" style="width: 0%"></div></div><div class="grid grid-cols-2 gap-4 text-center"><div class="border-r border-slate-100 pr-2"><div id="indVendas" class="text-3xl font-black text-green-600">0</div><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Vendas Fechadas</div></div><div class="pl-2"><div id="indLeads" class="text-3xl font-black text-slate-700">0</div><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Total Leads</div></div></div></div>
                 <div class="bg-slate-800 p-6 rounded-[2rem] shadow-xl text-white relative overflow-hidden"><div class="absolute top-0 right-0 w-24 h-24 bg-green-500/20 rounded-full -mr-8 -mt-8 blur-2xl"></div><div class="flex items-center gap-2 mb-3 relative z-10"><div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-robot text-green-400 animate-pulse"></i></div><span class="text-xs font-bold uppercase tracking-wider text-white/70">An√°lise do Coach</span></div><p id="indAnaliseIA" class="text-sm font-medium leading-relaxed opacity-90 relative z-10">Calculando...</p></div>
            </div>

            <!-- OUTRAS TELAS (MATERIAIS, OBJE√á√ïES, CADASTRO, LISTA) -->
            <div id="materiais" class="page hidden fade-in"><div class="flex items-center gap-4 mb-6"><button onclick="navegarPara('dashboard')" class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center text-slate-500 active:scale-90"><i class="fas fa-arrow-left"></i></button><h2 class="text-xl font-bold text-[#004c99]">Marketing</h2></div><div class="bg-white p-3 rounded-2xl shadow-sm mb-6 flex gap-3 border border-slate-100 sticky top-0 z-10"><div class="pl-2 flex items-center justify-center text-slate-400"><i class="fas fa-search"></i></div><input type="text" id="searchMateriais" onkeyup="buscarMateriais()" class="w-full outline-none text-slate-600 bg-transparent text-sm" placeholder="Buscar artes..."></div><div id="materiaisGrid" class="grid grid-cols-2 gap-4 pb-20"></div></div>
            <div id="objecoes" class="page hidden fade-in"><div class="flex items-center gap-4 mb-6"><button onclick="navegarPara('dashboard')" class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center text-slate-500 active:scale-90"><i class="fas fa-arrow-left"></i></button><h2 class="text-xl font-bold text-[#004c99]">Matriz de Obje√ß√µes</h2></div><div class="bg-white p-6 rounded-[1.5rem] shadow-sm border border-slate-100 space-y-4"><p class="text-sm text-slate-500 font-medium">Qual a obje√ß√£o do cliente?</p><textarea id="inputObjecaoGeral" class="input-padrao min-h-[100px]" placeholder="Ex: Cliente diz que a fidelidade √© muito alta..."></textarea><button onclick="combaterObjecaoGeral()" class="w-full bg-red-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2"><i class="fas fa-fist-raised"></i> COMBATER AGORA</button></div><div id="resultadoObjecaoGeral" class="mt-4 hidden p-5 bg-blue-50 rounded-2xl border border-blue-100 text-slate-700 text-sm leading-relaxed shadow-sm"></div></div>
            <div id="cadastroLead" class="page hidden fade-in"><div class="flex items-center gap-4 mb-6"><button onclick="navegarPara('dashboard')" class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center text-slate-500 active:scale-90"><i class="fas fa-arrow-left"></i></button><h2 class="text-xl font-bold text-[#004c99]">Ficha de Cadastro</h2></div><div class="bg-white p-6 rounded-[1.5rem] shadow-sm border border-slate-100 space-y-5"><button onclick="buscarEnderecoGPS()" class="w-full bg-blue-50 text-blue-700 border border-blue-200 p-4 rounded-xl font-bold text-xs uppercase tracking-wide flex items-center justify-center gap-2 active:bg-blue-100 mb-2"><i class="fas fa-location-crosshairs text-lg animate-pulse"></i> Usar GPS</button><div><label class="label-padrao">Nome do Cliente *</label><input type="text" id="leadNome" class="input-padrao" placeholder="Nome completo"></div><div><label class="label-padrao">WhatsApp *</label><input type="tel" id="leadTelefone" class="input-padrao" placeholder="(00) 00000-0000"></div><div><label class="label-padrao">Endere√ßo</label><input type="text" id="leadEndereco" class="input-padrao" placeholder="Rua, N√∫mero"></div><div class="grid grid-cols-2 gap-3"><div><label class="label-padrao">Bairro</label><input type="text" id="leadBairro" class="input-padrao" placeholder="Bairro"></div><div><label class="label-padrao">Cidade</label><input type="text" id="leadCidade" class="input-padrao" placeholder="Cidade"></div></div><div class="grid grid-cols-2 gap-3"><div><label class="label-padrao">Provedor Atual</label><input type="text" id="leadProvedor" class="input-padrao" placeholder="Ex: Vivo"></div><div><label class="label-padrao">N√≠vel Interesse</label><select id="leadInteresse" class="input-padrao bg-white"><option>Alto</option><option selected>M√©dio</option><option>Baixo</option></select></div></div><input type="hidden" id="leadLat"><input type="hidden" id="leadLon"><div><div class="flex justify-between items-end mb-1"><label class="label-padrao mb-0">Observa√ß√µes</label><div class="flex gap-2"><button id="btnMicNome" class="bg-slate-100 text-slate-500 w-8 h-8 rounded-lg flex items-center justify-center shadow-sm active:bg-red-50 active:text-red-500"><i class="fas fa-microphone"></i></button><button onclick="refinarObsIA()" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-[10px] font-bold shadow-sm active:scale-95"><i class="fas fa-magic"></i> Refinar</button></div></div><textarea id="leadObs" rows="3" class="input-padrao min-h-[100px]" placeholder="Detalhes importantes..."></textarea></div><button onclick="enviarLead()" class="w-full bg-[#00aeef] text-white font-bold py-4 rounded-xl shadow-xl mt-4 active:scale-95">SALVAR CADASTRO</button></div></div>
            <div id="gestaoLeads" class="page hidden fade-in"><div class="flex items-center justify-between mb-6 pl-1"><h2 class="text-2xl font-bold text-[#004c99]">Carteira</h2><button onclick="carregarLeads()" class="w-10 h-10 bg-white border border-slate-200 text-blue-600 rounded-full flex items-center justify-center shadow-sm active:scale-90"><i class="fas fa-sync text-sm"></i></button></div><div class="bg-white p-3 rounded-2xl shadow-sm mb-6 flex gap-3 border border-slate-100 sticky top-0 z-10"><div class="pl-2 flex items-center justify-center text-slate-400"><i class="fas fa-search"></i></div><input type="text" id="searchLead" onkeyup="renderLeads()" class="w-full outline-none text-slate-600 bg-transparent text-sm" placeholder="Buscar..."></div><div id="listaLeadsGestao" class="space-y-3 pb-20"></div></div>
        </main>

        <!-- MENU INFERIOR -->
        <nav class="glass-nav flex justify-around items-center p-2 pb-6 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] z-50 shrink-0 absolute bottom-0 w-full rounded-t-3xl h-24">
            <button id="nav-home" onclick="navegarPara('dashboard')" class="nav-item w-16 group flex flex-col items-center gap-1.5 text-[#00aeef] transition"><i class="fas fa-home text-xl group-[.active]:scale-110"></i><span class="text-[10px] font-bold">In√≠cio</span></button>
            <button id="nav-novo" onclick="navegarPara('cadastroLead')" class="nav-item relative -top-8 group"><div class="w-16 h-16 bg-[#00aeef] rounded-full shadow-lg flex items-center justify-center text-white border-4 border-slate-50 active:scale-90 transition transform hover:-translate-y-1"><i class="fas fa-plus text-2xl"></i></div></button>
            <button id="nav-lista" onclick="navegarPara('gestaoLeads')" class="nav-item w-16 group flex flex-col items-center gap-1.5 text-slate-400 transition"><i class="fas fa-users text-xl group-[.active]:scale-110 group-[.active]:text-[#00aeef]"></i><span class="text-[10px] font-bold">Leads</span></button>
        </nav>
    </div>

    <!-- MODAL NOVA TAREFA -->
    <div id="taskModal" class="hidden fixed inset-0 z-[80] bg-black/60 backdrop-blur-sm flex justify-center items-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative fade-in scale-up">
            <button onclick="document.getElementById('taskModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-300 hover:text-slate-500"><i class="fas fa-times"></i></button>
            <h3 class="text-lg font-bold text-slate-800 mb-4">Nova Tarefa</h3>
            <div class="space-y-4">
                <div><label class="label-padrao">Descri√ß√£o</label><input type="text" id="taskDesc" class="input-padrao" placeholder="Ex: Cobrar contrato..."></div>
                <div><label class="label-padrao">Data Limite</label><input type="date" id="taskDate" class="input-padrao"></div>
                <div><label class="label-padrao">Vincular a Lead (Opcional)</label><select id="taskLeadSelect" class="input-padrao bg-white text-sm"><option value="">Nenhum</option></select></div>
                <button onclick="salvarTarefa()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg mt-2">CRIAR TAREFA</button>
            </div>
        </div>
    </div>

    <!-- MODAL DETALHES LEAD -->
    <div id="leadModal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex justify-center items-end sm:items-center"><div onclick="fecharLeadModal()" class="absolute inset-0"></div><div class="bg-white w-full sm:w-[450px] sm:rounded-3xl rounded-t-[2.5rem] p-6 relative shadow-2xl slide-up max-h-[95vh] overflow-y-auto"><div class="flex justify-between items-center mb-6"><button onclick="excluirLead()" class="w-10 h-10 bg-red-50 text-red-500 rounded-full flex items-center justify-center hover:bg-red-100 active:scale-90 transition"><i class="fas fa-trash-alt"></i></button><button onclick="editarLeadAtual()" class="w-10 h-10 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center hover:text-[#00aeef] active:scale-90 border border-slate-200"><i class="fas fa-pen"></i></button></div><div class="mb-8 pr-10"><h3 id="modalLeadNome" class="text-2xl font-bold text-slate-800 leading-tight">Nome</h3><p id="modalLeadInfo" class="text-slate-400 text-xs font-bold uppercase tracking-wider mt-1 flex items-center gap-2"><i class="fas fa-map-marker-alt"></i> Detalhes</p><div id="modalLeadFlag" class="mt-3"></div></div><div class="bg-red-50 p-5 rounded-2xl mb-6 border border-red-100"><label class="label-padrao text-red-800 mb-2 flex items-center gap-2"><i class="fas fa-shield-alt text-red-500"></i> Quebra de Obje√ß√£o</label><div class="flex gap-2 mb-3"><input type="text" id="inputObjecaoLead" class="input-padrao h-10 text-sm border-red-200 focus:border-red-400" placeholder="Ex: Pre√ßo, Fidelidade..."><button onclick="combaterObjecaoLead()" class="bg-red-500 text-white w-12 rounded-xl shadow-md active:scale-90 flex items-center justify-center"><i class="fas fa-magic"></i></button></div><textarea id="respostaObjecaoLead" rows="3" class="w-full bg-white text-sm text-slate-600 border border-red-200 rounded-xl p-3 shadow-sm focus:border-red-300" placeholder="A IA vai sugerir o argumento aqui..."></textarea><div class="flex justify-between items-center mt-2"><div class="flex gap-2"><button onclick="copiarTexto('respostaObjecaoLead')" class="text-xs font-bold text-red-400 uppercase hover:text-red-600"><i class="far fa-copy"></i> Copiar</button><button onclick="enviarZapTexto('respostaObjecaoLead')" class="text-xs font-bold text-green-500 uppercase hover:text-green-700"><i class="fab fa-whatsapp"></i> Enviar</button></div><button onclick="salvarObjecaoLead()" class="text-[10px] font-bold text-red-500 uppercase hover:text-red-700">Salvar</button></div></div><div class="bg-slate-50 p-5 rounded-2xl mb-6 border border-slate-100 relative"><button onclick="analiseEstrategicaIA()" class="absolute -top-3 right-5 bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-3 py-1 rounded-full text-[10px] font-bold shadow-lg flex items-center gap-1 active:scale-95"><i class="fas fa-chess-knight"></i> Estrat√©gia</button><div class="flex justify-between items-center mb-4"><span class="text-xs text-slate-400 font-bold uppercase tracking-wider">Provedor Atual</span><span id="modalLeadProvedor" class="text-sm font-bold text-slate-700 bg-white px-3 py-1 rounded-lg border border-slate-100 shadow-sm">--</span></div><hr class="border-slate-200 my-3"><div class="text-xs text-slate-400 font-bold uppercase mb-2">Observa√ß√µes</div><textarea id="modalLeadObs" rows="3" class="w-full bg-white text-sm text-slate-600 outline-none resize-none border border-slate-200 rounded-xl p-3 shadow-sm focus:border-blue-300" placeholder="Adicionar nota..."></textarea><div class="flex justify-between items-center mt-3"><div class="flex gap-2"><button onclick="copiarTexto('modalLeadObs')" class="text-xs font-bold text-slate-400 uppercase hover:text-blue-500"><i class="far fa-copy"></i></button><button onclick="enviarZapTexto('modalLeadObs')" class="text-xs font-bold text-slate-400 uppercase hover:text-green-500"><i class="fab fa-whatsapp"></i></button></div><button onclick="salvarObservacaoModal()" class="text-[10px] font-bold text-blue-500 uppercase hover:text-blue-700 flex items-center justify-end gap-1"><i class="fas fa-save"></i> Salvar Obs</button></div></div><div class="mb-6 bg-blue-50 p-5 rounded-2xl border border-blue-100"><label class="label-padrao flex items-center gap-2 mb-3 text-blue-800"><div class="bg-blue-200 p-1.5 rounded-md"><i class="fas fa-calendar-alt text-blue-600"></i></div>Agendar Retorno</label><div class="flex gap-3"><input type="date" id="agendarData" class="flex-1 p-3 bg-white border border-blue-200 rounded-xl text-sm font-bold text-slate-600 outline-none focus:ring-2 focus:ring-blue-300"><input type="time" id="agendarHora" class="w-28 p-3 bg-white border border-blue-200 rounded-xl text-sm font-bold text-slate-600 outline-none focus:ring-2 focus:ring-blue-300"></div><button onclick="salvarAgendamento()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition mt-4 hover:bg-blue-700 flex items-center justify-center gap-2">CONFIRMAR <i class="fas fa-check-circle"></i></button></div><button onclick="marcarVendaFechada()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 active:scale-95 transition mb-6 flex items-center justify-center gap-2"><i class="fas fa-handshake"></i> VENDA FECHADA! üí∞</button><div class="grid grid-cols-2 gap-3"><button onclick="fecharLeadModal()" class="p-4 rounded-xl border border-slate-200 font-bold text-slate-500 text-sm active:bg-slate-50 transition">Fechar</button><button id="btnModalWhats" class="p-4 rounded-xl bg-green-500 text-white font-bold shadow-md flex items-center justify-center gap-2 text-sm active:scale-95 transition hover:bg-green-600"><i class="fab fa-whatsapp text-xl"></i> Chamar</button></div></div></div>
    
    <!-- CHAT e LOADER mantidos -->
    <div id="chatModal" class="hidden fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex justify-center items-center p-4"><div onclick="toggleChat()" class="absolute inset-0"></div><div class="bg-white w-full max-w-md h-[70vh] rounded-3xl flex flex-col shadow-2xl overflow-hidden relative fade-in scale-up"><div class="bg-[#004c99] p-5 text-white font-bold flex justify-between items-center shadow-md z-10"><span class="flex items-center gap-3"><i class="fas fa-robot text-blue-200 text-xl"></i> Assistente MHNET</span><button onclick="toggleChat()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition"><i class="fas fa-times text-sm"></i></button></div><div id="chatHistory" class="flex-1 p-5 overflow-y-auto space-y-4 bg-slate-50"></div><div class="p-4 border-t bg-white flex gap-3 items-center"><input type="text" id="chatInput" class="flex-1 bg-slate-100 p-4 pl-5 rounded-full outline-none text-sm focus:ring-2 focus:ring-blue-100 transition text-slate-700" placeholder="Pergunte √† IA..."><button onclick="enviarMensagemChat()" class="bg-[#00aeef] text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition hover:bg-blue-500"><i class="fas fa-paper-plane text-sm"></i></button></div></div></div>
    <div id="loader" class="hidden fixed inset-0 z-[70] bg-white/90 backdrop-blur-md flex flex-col items-center justify-center fade-in"><div class="relative"><div class="w-20 h-20 border-4 border-blue-100 border-t-[#00aeef] rounded-full animate-spin"></div><div class="absolute inset-0 flex items-center justify-center"><img src="https://mhnet.com.br/assets/img/logo_branca.png" class="h-6 opacity-50 grayscale invert"></div></div><p id="loaderText" class="text-slate-400 font-bold text-xs tracking-[0.2em] mt-6 animate-pulse">CARREGANDO</p></div>

    <script>
    // ‚ö†Ô∏è SUBSTITUA PELO SEU ID NOVO DO BACKEND V84
    const DEPLOY_ID = 'AKfycbz1-H8r52Z_j3w8zF5u3L5b2yX9c6v7b4n0m1k2l3p4q5r6s7t8'; 
    const API_URL = `https://script.google.com/macros/s/${DEPLOY_ID}/exec`;

    let loggedUser = localStorage.getItem('loggedUser');
    let leadsCache = [];
    let leadAtualParaAgendar = null; 
    let chatHistoryData = []; 
    let currentFolderId = null;
    let editingLeadIndex = null;
    let editingAbsenceIndex = null; 

    document.addEventListener('DOMContentLoaded', () => {
        carregarVendedores();
        const saved = localStorage.getItem('mhnet_leads_cache');
        if(saved) { try { leadsCache = JSON.parse(saved); } catch(e) {} }
        
        if (loggedUser) {
             initApp();
        } else {
             document.getElementById('userMenu').style.display = 'flex';
             document.getElementById('mainContent').style.display = 'none';
        }
    });

    function showLoading(show, txt) { 
        const l = document.getElementById('loader'); 
        if(l) l.style.display = show ? 'flex' : 'none'; 
        const t = document.getElementById('loaderText');
        if(t && txt) t.innerText = txt;
    }

    // --- TAREFAS ---
    async function carregarTarefas() {
        const div = document.getElementById('listaTarefasContainer');
        div.innerHTML = '<div class="text-center p-5 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
        const res = await apiCall('getTasks', { vendedor: loggedUser }, false);
        if (res && res.status === 'success') {
            const tasks = res.data;
            if (res.isAdmin) { const panel = document.getElementById('adminPanel'); if(panel) panel.classList.remove('hidden'); }
            if (tasks.length === 0) { div.innerHTML = '<div class="text-center p-10 text-gray-300 flex flex-col items-center"><i class="fas fa-clipboard-check text-4xl mb-2"></i><p>Nenhuma tarefa pendente.</p></div>'; return; }
            div.innerHTML = tasks.map(t => {
                const checked = t.status === "CONCLUIDA" ? "checked" : "";
                const opacity = t.status === "CONCLUIDA" ? "opacity-50 line-through" : "";
                return `<div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center gap-3 ${opacity}"><input type="checkbox" ${checked} onchange="toggleTask('${t.id}', '${t.status}')" class="w-5 h-5 accent-blue-600 rounded cursor-pointer"><div class="flex-1"><div class="text-sm font-bold text-slate-700">${t.descricao}</div><div class="text-[10px] text-slate-400 flex items-center gap-2 mt-1">${t.dataLimite ? `<span class="bg-red-50 text-red-400 px-1.5 py-0.5 rounded flex items-center gap-1"><i class="fas fa-calendar"></i> ${t.dataLimite}</span>` : ''}${t.nomeLead ? `<span class="bg-blue-50 text-blue-500 px-1.5 py-0.5 rounded flex items-center gap-1"><i class="fas fa-user"></i> ${t.nomeLead}</span>` : ''}${res.isAdmin ? `<span class="text-orange-400 font-bold ml-auto">${t.vendedor}</span>` : ''}</div></div></div>`;
            }).join('');
        } else div.innerHTML = '<div class="text-center text-red-400">Erro ao carregar tarefas.</div>';
    }
    function abrirModalTarefa() { document.getElementById('taskModal').classList.remove('hidden'); const sel = document.getElementById('taskLeadSelect'); sel.innerHTML = '<option value="">Nenhum (Avulso)</option>'; leadsCache.forEach(l => { const opt = document.createElement('option'); opt.value = l.nomeLead; opt.innerText = l.nomeLead; sel.appendChild(opt); }); }
    async function salvarTarefa() { const desc = document.getElementById('taskDesc').value; const date = document.getElementById('taskDate').value; const leadVal = document.getElementById('taskLeadSelect').value; if(!desc) return alert("Digite a descri√ß√£o."); showLoading(true, "SALVANDO..."); const res = await apiCall('addTask', { vendedor: loggedUser, descricao: desc, dataLimite: date, nomeLead: leadVal }); showLoading(false); if(res && res.status === 'success') { document.getElementById('taskModal').classList.add('hidden'); document.getElementById('taskDesc').value = ''; carregarTarefas(); } else alert("Erro ao salvar tarefa."); }
    async function toggleTask(id, currentStatus) { await apiCall('toggleTask', { taskId: id, status: currentStatus, vendedor: loggedUser }, false); carregarTarefas(); }

    // --- FALTAS ---
    async function verHistoricoFaltas() {
        const div = document.getElementById('listaHistoricoFaltas');
        document.getElementById('historicoFaltasContainer').classList.remove('hidden');
        document.getElementById('formFaltaContainer').classList.add('hidden');
        div.innerHTML = '<div class="text-center p-5 text-gray-400"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
        const res = await apiCall('getAbsences', { vendedor: loggedUser }, false);
        if (res && res.status === 'success' && res.data.length > 0) {
            div.innerHTML = res.data.map(f => `<div onclick='preencherEdicaoFalta(${JSON.stringify(f)})' class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm mb-2 cursor-pointer active:bg-blue-50"><div class="flex justify-between items-start"><div><div class="font-bold text-xs text-slate-700">${f.motivo}</div><div class="text-[10px] text-slate-400">${f.dataFalta} ‚Ä¢ ${f.statusEnvio}</div></div><i class="fas fa-pen text-slate-300 text-xs"></i></div></div>`).join('');
        } else { div.innerHTML = '<div class="text-center p-5 text-gray-400 text-xs">Nenhum hist√≥rico encontrado.</div>'; }
    }
    function ocultarHistoricoFaltas() { document.getElementById('historicoFaltasContainer').classList.add('hidden'); document.getElementById('formFaltaContainer').classList.remove('hidden'); editingAbsenceIndex = null; document.getElementById('faltaData').value = ''; document.getElementById('faltaMotivo').value = ''; document.getElementById('faltaObs').value = ''; document.getElementById('faltaArquivo').value = ''; document.getElementById('btnEnviarFalta').innerHTML = '<i class="fas fa-paper-plane"></i> ENVIAR SOLICITA√á√ÉO'; document.getElementById('btnEnviarFalta').className = "w-full bg-[#00aeef] text-white font-bold py-4 rounded-xl shadow-xl mt-4 active:scale-95 transition flex items-center justify-center gap-2"; }
    function preencherEdicaoFalta(falta) { document.getElementById('historicoFaltasContainer').classList.add('hidden'); document.getElementById('formFaltaContainer').classList.remove('hidden'); const [d, m, a] = falta.dataFalta.split('/'); document.getElementById('faltaData').value = `${a}-${m}-${d}`; document.getElementById('faltaMotivo').value = falta.motivo; document.getElementById('faltaObs').value = falta.obs; editingAbsenceIndex = falta._linha; const btn = document.getElementById('btnEnviarFalta'); btn.innerHTML = '<i class="fas fa-sync"></i> ATUALIZAR & REENVIAR'; btn.className = "w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-xl mt-4 active:scale-95 transition flex items-center justify-center gap-2"; alert("üìù Editando solicita√ß√£o. Anexe o atestado novamente se necess√°rio."); }
    async function enviarJustificativa() { const dataFalta = document.getElementById('faltaData').value; const motivo = document.getElementById('faltaMotivo').value; const obs = document.getElementById('faltaObs').value; const fileInput = document.getElementById('faltaArquivo'); if(!dataFalta || !motivo) return alert("Preencha data e motivo."); showLoading(true, editingAbsenceIndex ? "ATUALIZANDO..." : "ENVIANDO..."); const payload = { vendedor: loggedUser, dataFalta: dataFalta, motivo: motivo, observacao: obs, _linha: editingAbsenceIndex }; const route = editingAbsenceIndex ? 'updateAbsence' : 'registerAbsence'; if (fileInput.files.length > 0) { const file = fileInput.files[0]; const reader = new FileReader(); reader.onload = async function(e) { payload.fileData = e.target.result; payload.fileName = file.name; payload.mimeType = file.type; await enviarPayloadFalta(route, payload); }; reader.readAsDataURL(file); } else { if(editingAbsenceIndex) payload.existingFile = ""; await enviarPayloadFalta(route, payload); } }
    async function enviarPayloadFalta(route, payload) { const res = await apiCall(route, payload); showLoading(false); if (res && res.status === 'success') { alert(editingAbsenceIndex ? "‚úÖ Atualizado com sucesso!" : "‚úÖ Enviado com sucesso!"); ocultarHistoricoFaltas(); navegarPara('dashboard'); } else alert("Erro: " + (res?.message || "Desconhecido")); }

    // --- INDICADORES ---
    async function abrirIndicadores() { navegarPara('indicadores'); document.getElementById('indMes').innerText = '--/--'; document.getElementById('indCiclo').innerText = 'Carregando...'; document.getElementById('indVendas').innerText = '...'; document.getElementById('indLeads').innerText = '...'; document.getElementById('indAnaliseIA').innerText = 'Analisando...'; document.getElementById('indProgresso').style.width = '0%'; const res = await apiCall('getIndicators', { vendedor: loggedUser }, false); if (res && res.status === 'success') { const d = res.data; document.getElementById('indMes').innerText = d.mes; document.getElementById('indCiclo').innerText = `Ciclo: ${d.ciclo}`; document.getElementById('indVendas').innerText = d.vendas; document.getElementById('indLeads').innerText = d.totalLeads; document.getElementById('indMetaTexto').innerText = `${d.vendas} / ${d.meta}`; document.getElementById('indProgresso').style.width = `${Math.min(d.porcentagem, 100)}%`; const barra = document.getElementById('indProgresso'); if (d.porcentagem >= 100) barra.className = "bg-green-500 h-4 rounded-full progress-bar"; else if (d.porcentagem >= 70) barra.className = "bg-blue-500 h-4 rounded-full progress-bar"; else barra.className = "bg-orange-500 h-4 rounded-full progress-bar"; const resIA = await apiCall('analyzeIndicators', { vendas: d.vendas, meta: d.meta, diasUteisRestantes: d.diasUteisRestantes }, false); if (resIA && resIA.status === 'success') document.getElementById('indAnaliseIA').innerText = resIA.message; else document.getElementById('indAnaliseIA').innerText = "Foco na meta!"; } else { document.getElementById('indAnaliseIA').innerText = 'Sem dados.'; } }

    // --- UTILIT√ÅRIOS ---
    function copiarTexto(id) { const el = document.getElementById(id); if(!el) return; el.select(); el.setSelectionRange(0, 99999); document.execCommand('copy'); alert("üìã Copiado!"); }
    function enviarZapTexto(id) { const el = document.getElementById(id); if(!el) return; const texto = el.value || el.innerText; if(!texto) return alert("Nada para enviar."); window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, '_blank'); }
    async function excluirLead() { if (!leadAtualParaAgendar) return; if (!confirm("‚ö†Ô∏è EXCLUIR este lead permanentemente?")) return; showLoading(true, "EXCLUINDO..."); const res = await apiCall('deleteLead', { vendedor: loggedUser, nomeLead: leadAtualParaAgendar.nomeLead }); showLoading(false); if(res && res.status === 'success') { alert("‚úÖ Lead exclu√≠do."); const index = leadsCache.indexOf(leadAtualParaAgendar); if (index > -1) leadsCache.splice(index, 1); localStorage.setItem('mhnet_leads_cache', JSON.stringify(leadsCache)); fecharLeadModal(); renderLeads(); atualizarDashboard(); } else alert("Erro ao excluir."); }
    async function marcarVendaFechada() { if (!leadAtualParaAgendar) return; if (!confirm("üéâ Confirmar VENDA FECHADA?")) return; showLoading(true, "PARAB√âNS! üöÄ"); const res = await apiCall('updateStatus', { vendedor: loggedUser, nomeLead: leadAtualParaAgendar.nomeLead, status: "Venda Fechada" }); showLoading(false); if(res && res.status === 'success') { alert("üéâ Venda registrada!"); leadAtualParaAgendar.status = "Venda Fechada"; leadAtualParaAgendar.interesse = "VENDIDO"; localStorage.setItem('mhnet_leads_cache', JSON.stringify(leadsCache)); fecharLeadModal(); renderLeads(); } }
    async function combaterObjecaoGeral() { const obj = document.getElementById('inputObjecaoGeral').value; if(!obj) return alert("Digite a obje√ß√£o."); showLoading(true, "CONSULTANDO MATRIZ..."); const res = await apiCall('solveObjection', { objection: obj }); showLoading(false); if(res && res.status === 'success') { const div = document.getElementById('resultadoObjecaoGeral'); div.innerHTML = `<div id="textoResObjGeral"><b>üí° Sugest√£o:</b><br>${res.answer.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>')}</div><div class="flex gap-2 mt-3 justify-end border-t border-blue-200 pt-2"><button onclick="copiarTexto('textoResObjGeral')" class="text-blue-500 text-xs font-bold uppercase"><i class="far fa-copy"></i> Copiar</button><button onclick="enviarZapTexto('textoResObjGeral')" class="text-green-500 text-xs font-bold uppercase"><i class="fab fa-whatsapp"></i> Enviar</button></div>`; div.classList.remove('hidden'); } else alert("Erro na IA."); }
    async function combaterObjecaoLead() { if (!leadAtualParaAgendar) return; const obj = document.getElementById('inputObjecaoLead').value; if(!obj) return alert("Digite a obje√ß√£o."); showLoading(true, "GERANDO..."); const res = await apiCall('solveObjection', { objection: obj }); showLoading(false); if(res && res.status === 'success') { const cleanText = res.answer.replace(/[\*#]/g, ''); document.getElementById('respostaObjecaoLead').value = cleanText; } }
    async function salvarObjecaoLead() { if (!leadAtualParaAgendar) return; const obj = document.getElementById('inputObjecaoLead').value; const ans = document.getElementById('respostaObjecaoLead').value; if(!obj || !ans) return alert("Gere uma resposta."); showLoading(true, "SALVANDO..."); const res = await apiCall('saveObjectionLead', { vendedor: loggedUser, nomeLead: leadAtualParaAgendar.nomeLead, objection: obj, answer: ans }); showLoading(false); if(res && res.status === 'success') { alert("‚úÖ Salvo no hist√≥rico!"); leadAtualParaAgendar.objecao = obj; leadAtualParaAgendar.respostaObjecao = ans; localStorage.setItem('mhnet_leads_cache', JSON.stringify(leadsCache)); } }
    function initApp() { document.getElementById('userMenu').style.display = 'none'; document.getElementById('mainContent').style.display = 'flex'; const elUser = document.getElementById('userInfo'); if(elUser) { elUser.innerText = loggedUser; elUser.classList.remove('truncate', 'max-w-[150px]'); } atualizarDataCabecalho(); atualizarDashboard(); navegarPara('dashboard'); carregarLeads(false); }
    function atualizarDashboard() { const hoje = new Date().toLocaleDateString('pt-BR').split(' ')[0]; const count = leadsCache.filter(l => (l.timestamp || '').includes(hoje)).length; if(document.getElementById('statLeads')) document.getElementById('statLeads').innerText = count; const retornos = leadsCache.filter(l => l.agendamento && l.agendamento.includes(hoje)); const container = document.getElementById('listaAtaqueDashboard'); if (container) { if (retornos.length > 0) { container.innerHTML = `<div class="mb-2 flex items-center justify-between"><span class="text-xs font-bold text-orange-600 uppercase tracking-wider">üî• Prioridade Hoje (${retornos.length})</span></div><div class="space-y-2">${retornos.map(l => { const idx = leadsCache.indexOf(l); return `<div onclick="abrirLeadDetalhes(${idx})" class="bg-white p-3 rounded-xl border-l-4 border-l-orange-500 shadow-sm flex justify-between items-center active:bg-orange-50 cursor-pointer"><div><div class="font-bold text-slate-800 text-sm">${l.nomeLead}</div><div class="text-[10px] text-slate-500"><i class="fas fa-clock"></i> ${l.agendamento.split(' ')[1] || 'Dia todo'}</div></div><i class="fas fa-chevron-right text-slate-300 text-xs"></i></div>`; }).join('')}</div>`; container.classList.remove('hidden'); } else { container.innerHTML = ''; container.classList.add('hidden'); } } }
    function navegarPara(pageId) { document.querySelectorAll('.page').forEach(el => { el.style.display = 'none'; el.classList.remove('fade-in'); }); const target = document.getElementById(pageId); if(target) { target.style.display = 'block'; void target.offsetWidth; target.classList.add('fade-in'); } const scroller = document.getElementById('main-scroll'); if(scroller) scroller.scrollTo({ top: 0, behavior: 'smooth' }); if (pageId === 'gestaoLeads') { const busca = document.getElementById('searchLead'); if(busca) { busca.value = ""; busca.placeholder = "Buscar por nome, bairro..."; } renderLeads(); } if (pageId === 'cadastroLead') { ajustarMicrofone(); if (editingLeadIndex === null) { ['leadNome','leadTelefone','leadProvedor','leadObs','leadEndereco','leadBairro','leadCidade'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; }); } } if (pageId === 'materiais' && !currentFolderId) setTimeout(() => carregarMateriais(null), 100); if (pageId === 'dashboard') atualizarDashboard(); if(pageId === 'indicadores') abrirIndicadores(); if(pageId === 'tarefas') carregarTarefas(); }
    function ajustarMicrofone() { const btnMic = document.getElementById('btnMicNome'); if (btnMic) { btnMic.removeAttribute('onclick'); btnMic.onclick = function() { iniciarDitado('leadObs', 'btnMicNome'); }; } }
    async function apiCall(route, payload, show=true) { if(show) showLoading(true); try { const res = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'text/plain;charset=utf-8'}, body: JSON.stringify({ route: route, payload: payload }) }); if (!res.ok) throw new Error(`HTTP ${res.status}`); const text = await res.text(); let json; try { json = JSON.parse(text); } catch(e) { throw new Error("Erro formato JSON."); } if(show) showLoading(false); return json; } catch(e) { if(show) showLoading(false); if(['addLead', 'updateAgendamento', 'updateObservacao'].includes(route)) return {status:'success', local: true}; return {status: 'error', message: e.message}; } }
    async function carregarVendedores() { const select = document.getElementById('userSelect'); if(!select) return; const VENDEDORES_OFFLINE = ["Ana Paula Rodrigues", "Vitoria Caroline Baldez Rosales", "Jo√£o Vithor Sader", "Jo√£o Paulo da Silva Santos", "Claudia Maria Semmler", "Diulia Vitoria Machado Borges", "Elton da Silva Rodrigo Gon√ßalves", "Bruno Garcia Queiroz"]; select.innerHTML = '<option value="">Conectando...</option>'; const timeout = new Promise((_, reject) => setTimeout(() => reject("Timeout"), 4000)); try { const res = await Promise.race([apiCall('getVendors', {}, false), timeout]); if (res && res.status === 'success' && res.data && res.data.length > 0) { select.innerHTML = '<option value="">Toque para selecionar...</option>'; res.data.forEach(v => { const opt = document.createElement('option'); opt.value = v.nome; opt.innerText = v.nome; select.appendChild(opt); }); } else throw new Error("Vazio"); } catch (e) { select.innerHTML = '<option value="">Modo Offline</option>'; VENDEDORES_OFFLINE.forEach(nome => { const opt = document.createElement('option'); opt.value = nome; opt.innerText = nome; select.appendChild(opt); }); } }
    function atualizarDataCabecalho() { const elData = document.getElementById('headerDate'); if(!elData) return; const dias = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'S√ÅB']; const meses = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ']; const agora = new Date(); elData.innerText = `${dias[agora.getDay()]}, ${agora.getDate()} ${meses[agora.getMonth()]}`; }
    function verificarAgendamentosHoje() { try { const hoje = new Date().toLocaleDateString('pt-BR').split(' ')[0]; const retornos = leadsCache.filter(l => l.agendamento && l.agendamento.includes(hoje)); const banner = document.getElementById('lembreteBanner'); const txt = document.getElementById('lembreteTexto'); if (retornos.length > 0) { if(banner) banner.classList.remove('hidden'); if(txt) txt.innerText = `Voc√™ tem ${retornos.length} retornos hoje.`; } else { if(banner) banner.classList.add('hidden'); } } catch (e) { console.error("Erro verificarAgendamentos:", e); } }
    async function carregarMateriais(f=null, s="") { const div = document.getElementById('materiaisGrid'); if (!div) return; currentFolderId = f; div.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-10 fade-in"><i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-[#00aeef]"></i><br>Buscando materiais...</div>'; try { const res = await apiCall('getImages', { folderId: f, search: s }, false); if (res && res.status === 'success' && res.data) { atualizarNavegacaoMateriais(res.isRoot); renderMateriais(res.data); } else { throw new Error(res?.message || "Erro desconhecido na API"); } } catch (error) { console.error("‚ùå Erro Materiais:", error); div.innerHTML = `<div class="col-span-2 text-center text-red-400 py-10"><i class="fas fa-wifi mb-2"></i><br>Falha na conex√£o.<br><button onclick="carregarMateriais('${f || ''}')" class="mt-3 bg-blue-100 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold">Tentar Novamente</button></div>`; } }
    function renderMateriais(i) { const div = document.getElementById('materiaisGrid'); if(!div) return; if(i.length === 0) { div.innerHTML = '<div class="col-span-2 text-center text-gray-400 py-10">Pasta vazia.</div>'; return; } div.innerHTML = i.map(item => { if (item.type === 'folder') { return `<div onclick="carregarMateriais('${item.id}')" class="bg-white p-4 rounded-2xl shadow-sm border border-blue-50 flex flex-col items-center justify-center gap-2 cursor-pointer active:scale-95 transition h-36 hover:bg-blue-50 group"><i class="fas fa-folder text-5xl text-[#00aeef] group-hover:scale-110 transition drop-shadow-sm"></i><span class="text-xs font-bold text-slate-600 text-center leading-tight line-clamp-2">${item.name}</span></div>`; } else { return `<div class="bg-white p-2 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-48 relative overflow-hidden group"><div class="h-32 w-full bg-gray-50 rounded-xl overflow-hidden relative"><img src="${item.thumbnail}" class="w-full h-full object-cover transition transform group-hover:scale-105" alt="${item.name}" loading="lazy" onerror="this.onerror=null; this.src='https://cdn-icons-png.flaticon.com/512/3342/3342137.png'; this.className='w-12 h-12 m-auto mt-8 opacity-50';"></div><div class="flex-1 flex items-center justify-between mt-2 px-1 gap-2"><span class="text-[10px] text-gray-500 font-bold truncate flex-1">${item.name}</span><a href="${item.downloadUrl || '#'}" download target="_blank" class="bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center shadow-sm active:scale-90 transition hover:bg-blue-200"><i class="fas fa-download text-xs"></i></a><button onclick="compartilharImagem('${item.viewUrl}')" class="bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md active:scale-90 transition hover:bg-green-600"><i class="fab fa-whatsapp"></i></button></div><a href="${item.viewUrl}" target="_blank" class="absolute top-3 right-3 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center backdrop-blur-sm opacity-0 group-hover:opacity-100 transition"><i class="fas fa-expand"></i></a></div>`; } }).join(''); }
    function atualizarNavegacaoMateriais(r) { const btnVoltar = document.querySelector('#materiais button'); const titleEl = document.querySelector('#materiais h2'); if(btnVoltar) { if(r) { btnVoltar.onclick = () => navegarPara('dashboard'); if(titleEl) titleEl.innerText = "Marketing"; } else { btnVoltar.onclick = () => { const searchInput = document.getElementById('searchMateriais'); if (searchInput) searchInput.value = ""; carregarMateriais(null); }; if(titleEl) titleEl.innerText = "Voltar"; } } }
    function buscarMateriais() { const input = document.getElementById('searchMateriais'); if (input) carregarMateriais(currentFolderId, input.value); }
    function compartilharImagem(u) { window.open(`https://wa.me/?text=${encodeURIComponent(u)}`, '_blank'); }
    async function carregarLeads(s=true) { const res = await apiCall('getLeads', { vendedor: loggedUser }, s); if (res && res.status === 'success') { leadsCache = res.data || []; leadsCache.sort((a, b) => b._linha - a._linha); localStorage.setItem('mhnet_leads_cache', JSON.stringify(leadsCache)); if(res.isAdmin) document.getElementById('adminPanel').classList.remove('hidden'); if(document.getElementById('listaLeadsGestao')) renderLeads(); atualizarDashboard(); verificarAgendamentosHoje(); } }
    function renderLeads() { const div = document.getElementById('listaLeadsGestao'); if (!div) return; const term = (document.getElementById('searchLead')?.value || '').toLowerCase(); const lista = leadsCache.filter(l => (l.nomeLead||'').toLowerCase().includes(term) || (l.bairro||'').toLowerCase().includes(term) || (l.provedor||'').toLowerCase().includes(term)); if (!lista.length) { div.innerHTML = '<div class="text-center mt-10 text-gray-400">Nada encontrado.</div>'; return; } div.innerHTML = lista.map((l, i) => { const realIndex = leadsCache.indexOf(l); return criarCardLead(l, realIndex); }).join(''); }
    function criarCardLead(l, index, destaque = false) { let badge = "bg-slate-100 text-slate-500"; if (l.interesse === 'Alto') badge = "bg-green-100 text-green-700 ring-1 ring-green-200"; if (l.interesse === 'Baixo') badge = "bg-blue-50 text-blue-400"; if (l.status === 'Venda Fechada') badge = "bg-green-500 text-white font-bold ring-2 ring-green-300"; const borda = destaque ? "border-l-4 border-l-orange-500 shadow-md bg-orange-50/50" : "border border-slate-100 shadow-sm bg-white"; return `<div onclick="abrirLeadDetalhes(${index})" class="${borda} p-5 rounded-2xl mb-3 cursor-pointer active:scale-[0.98] transition-all duration-200 relative overflow-hidden group"><div class="flex justify-between items-start relative z-10"><div class="flex-1 min-w-0 pr-3"><div class="font-bold text-slate-800 text-lg leading-tight mb-2 truncate">${l.nomeLead}</div><div class="flex flex-wrap gap-2">${l.bairro ? `<span class="text-[10px] bg-slate-50 text-slate-500 px-2.5 py-1 rounded-lg font-bold uppercase tracking-wider flex items-center border border-slate-200"><i class="fas fa-map-pin mr-1.5 text-slate-400"></i>${l.bairro}</span>` : ''}${l.provedor ? `<span class="text-[10px] bg-indigo-50 text-indigo-600 px-2.5 py-1 rounded-lg font-bold uppercase tracking-wider flex items-center border border-indigo-100"><i class="fas fa-wifi mr-1.5"></i>${l.provedor}</span>` : ''}</div></div><div class="flex flex-col items-end gap-2 shrink-0"><span class="text-[10px] font-bold px-3 py-1 rounded-full ${badge}">${l.status === 'Venda Fechada' ? 'VENDIDO' : (l.interesse || 'M√©dio')}</span>${l.agendamento ? `<span class="text-[10px] text-orange-600 font-bold bg-white px-2 py-1 rounded-lg border border-orange-100 shadow-sm flex items-center"><i class="fas fa-clock mr-1"></i> ${l.agendamento.split(' ')[0]}</span>` : ''}</div></div></div>`; }
    function abrirLeadDetalhes(i) { const l = leadsCache[i]; if(!l) return; leadAtualParaAgendar = l; const setText = (id, t) => { const el = document.getElementById(id); if(el) el.innerText = t; }; setText('modalLeadNome', l.nomeLead); setText('modalLeadInfo', `${l.bairro || '-'} ‚Ä¢ ${l.telefone}`); setText('modalLeadProvedor', l.provedor || '--'); document.getElementById('modalLeadObs').value = l.observacao || ""; document.getElementById('inputObjecaoLead').value = l.objecao || ""; document.getElementById('respostaObjecaoLead').value = l.respostaObjecao || ""; const containerProv = document.getElementById('modalLeadProvedor')?.parentElement; if(containerProv && !document.getElementById('btnRaioXModal')) { const btn = document.createElement('button'); btn.id = 'btnRaioXModal'; btn.className = "ml-2 bg-slate-800 text-white px-2 py-1 rounded text-[10px] font-bold shadow hover:bg-slate-700 transition flex items-center gap-1"; btn.innerHTML = '<i class="fas fa-bolt text-yellow-400"></i> Raio-X'; btn.onclick = (e) => { e.stopPropagation(); raioXConcorrencia(); }; containerProv.appendChild(btn); } const btnWhats = document.getElementById('btnModalWhats'); if (btnWhats) btnWhats.onclick = () => window.open(`https://wa.me/55${l.telefone.replace(/\D/g,'')}`, '_blank'); const m = document.getElementById('leadModal'); if (m) { m.classList.remove('hidden'); const c = m.querySelector('div.slide-up'); if(c) { c.classList.remove('slide-up'); void c.offsetWidth; c.classList.add('slide-up'); } } }
    function fecharLeadModal() { document.getElementById('leadModal').classList.add('hidden'); leadAtualParaAgendar = null; editingLeadIndex = null; }
    window.editarLeadAtual = function() { if (!leadAtualParaAgendar) { alert("Selecione um lead."); return; } if(!confirm(`Editar cadastro de ${leadAtualParaAgendar.nomeLead}?`)) return; const lead = leadAtualParaAgendar; editingLeadIndex = leadsCache.indexOf(lead); const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ""; }; setVal('leadNome', lead.nomeLead); setVal('leadTelefone', lead.telefone); setVal('leadProvedor', lead.provedor); setVal('leadObs', lead.observacao); setVal('leadEndereco', lead.endereco); setVal('leadBairro', lead.bairro); setVal('leadCidade', lead.cidade); const selInt = document.getElementById('leadInteresse'); if(selInt) selInt.value = lead.interesse || "M√©dio"; fecharLeadModal(); navegarPara('cadastroLead'); };
    async function enviarLead() { const nome = document.getElementById('leadNome').value.trim(); const tel = document.getElementById('leadTelefone').value.trim(); if (!nome || !tel) return alert("Preencha Nome e WhatsApp"); if (editingLeadIndex !== null) { alert("‚ö†Ô∏è Edi√ß√£o: Atualiza apenas Observa√ß√µes no servidor."); const obs = document.getElementById('leadObs').value; if (obs) { apiCall('updateObservacao', { vendedor: loggedUser, nomeLead: nome, observacao: obs }); leadsCache[editingLeadIndex].observacao = obs; localStorage.setItem('mhnet_leads_cache', JSON.stringify(leadsCache)); } editingLeadIndex = null; navegarPara('gestaoLeads'); return; } const novoLead = { vendedor: loggedUser, nomeLead: nome, telefone: tel, endereco: document.getElementById('leadEndereco').value, cidade: document.getElementById('leadCidade').value, bairro: document.getElementById('leadBairro').value, interesse: document.getElementById('leadInteresse').value, provedor: document.getElementById('leadProvedor').value, observacao: document.getElementById('leadObs').value, agendamento: "" }; const res = await apiCall('addLead', novoLead); if (res && (res.status === 'success' || res.local)) { alert('‚úÖ Salvo!'); leadsCache.unshift(novoLead); localStorage.setItem('mhnet_leads_cache', JSON.stringify(leadsCache)); ['leadNome', 'leadTelefone', 'leadObs', 'leadEndereco', 'leadBairro', 'leadProvedor'].forEach(id => document.getElementById(id).value = ''); navegarPara('gestaoLeads'); } else alert('Erro.'); }
    async function salvarAgendamento() { if (!leadAtualParaAgendar) return; const dt = document.getElementById('agendarData').value; const hr = document.getElementById('agendarHora').value; if (!dt) return alert("Informe a data!"); const [a, m, d] = dt.split('-'); const ag = `${d}/${m}/${a} ${hr || '09:00'}`; const res = await apiCall('updateAgendamento', { vendedor: loggedUser, nomeLead: leadAtualParaAgendar.nomeLead, agendamento: ag }); if(res && (res.status === 'success' || res.local)) { alert("‚úÖ Agendado! O Gestor ser√° notificado."); leadAtualParaAgendar.agendamento = ag; localStorage.setItem('mhnet_leads_cache', JSON.stringify(leadsCache)); fecharLeadModal(); verificarAgendamentosHoje(); renderLeads(); } }
    async function salvarObservacaoModal() { if (!leadAtualParaAgendar) return; const obs = document.getElementById('modalLeadObs').value; const res = await apiCall('updateObservacao', { vendedor: loggedUser, nomeLead: leadAtualParaAgendar.nomeLead, observacao: obs }); if(res) { alert("Salvo!"); leadAtualParaAgendar.observacao = obs; localStorage.setItem('mhnet_leads_cache', JSON.stringify(leadsCache)); } }
    window.filtrarRetornos = function() { const hoje = new Date().toLocaleDateString('pt-BR').split(' ')[0]; navegarPara('gestaoLeads'); const input = document.getElementById('searchLead'); if(input) { input.value = ""; input.placeholder = `üìÖ Retornos de Hoje (${hoje})`; } const div = document.getElementById('listaLeadsGestao'); const retornos = leadsCache.filter(l => l.agendamento && l.agendamento.includes(hoje)); if(!retornos.length) { div.innerHTML = '<div class="text-center mt-10 font-bold text-slate-400">Nenhum retorno hoje! üò¥</div>'; return; } div.innerHTML = retornos.map(l => { const idx = leadsCache.indexOf(l); return criarCardLead(l, idx, true); }).join(''); };
    async function analiseEstrategicaIA() { if (!leadAtualParaAgendar) return; const l = leadAtualParaAgendar; showLoading(true, "ANALISANDO..."); const prompt = `Analise este lead: Nome ${l.nomeLead}, Provedor ${l.provedor}, Interesse ${l.interesse}, Bairro ${l.bairro}. Sugira 3 t√°ticas de negocia√ß√£o espec√≠ficas.`; const resp = await perguntarIABackend(prompt); showLoading(false); if(resp) { const obsEl = document.getElementById('modalLeadObs'); obsEl.value = (obsEl.value ? obsEl.value + "\n\n" : "") + `[IA]: ${resp.replace(/\*\*/g, '')}`; alert("‚úÖ An√°lise adicionada √†s observa√ß√µes! Clique em 'Salvar Obs'."); } }
    async function raioXConcorrencia() { const provedor = document.getElementById('leadProvedor')?.value; if(!provedor) return alert("Preencha o provedor."); showLoading(true, "RAIO-X..."); const prompt = `Cliente usa ${provedor}. Liste 3 pontos fracos deles e 3 argumentos da MHNET para vencer.`; const resp = await perguntarIABackend(prompt); showLoading(false); if(resp) { const obs = document.getElementById('leadObs'); obs.value = (obs.value + "\n\n" + resp.replace(/\*\*/g, '')).trim(); } }
    async function refinarObsIA() { const obs = document.getElementById('leadObs'); if(!obs.value) return alert("Escreva algo primeiro."); showLoading(true, "REFINANDO..."); const resp = await perguntarIABackend(`Reescreva profissionalmente: "${obs.value}"`); showLoading(false); if(resp) obs.value = resp.replace(/\*\*/g, ''); }
    async function perguntarIABackend(p) { chatHistoryData.push(`User: ${p}`); const contexto = chatHistoryData.slice(-6); try { const res = await apiCall('askAI', { question: p, history: contexto }, false); if (res && res.status === 'success') { const resp = res.answer; chatHistoryData.push(`IA: ${resp}`); return resp; } else return "‚ö†Ô∏è IA indispon√≠vel."; } catch (e) { return "Erro de conex√£o."; } }
    async function gerarAbordagemIA() { const nome = document.getElementById('leadNome').value; if(!nome) return alert("Preencha o nome!"); showLoading(true, "CRIANDO PITCH..."); const txt = await perguntarIABackend(`Crie pitch curto WhatsApp para ${nome}.`); showLoading(false); if(txt) document.getElementById('leadObs').value = txt.replace(/["*#]/g, '').trim(); }
    async function gerarCoachIA() { showLoading(true, "COACH..."); const txt = await perguntarIABackend(`Frase motivacional vendas curta.`); showLoading(false); if(txt) alert(`üöÄ ${txt.replace(/\*\*/g,'')}`); }
    async function consultarPlanosIA() { toggleChat(); if(document.getElementById('chatHistory').innerHTML === "") { document.getElementById('chatHistory').innerHTML = `<div class="flex gap-3 fade-in"><div class="w-8 h-8 bg-blue-100 rounded-full flex-shrink-0 flex items-center justify-center text-[#004c99] text-xs"><i class="fas fa-robot"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none border border-gray-100 text-sm text-gray-600 shadow-sm">Ol√°! Pergunte sobre planos.</div></div>`; } }
    function toggleChat() { const el = document.getElementById('chatModal'); if(el.classList.contains('hidden')) { el.classList.remove('hidden'); setTimeout(() => document.getElementById('chatInput')?.focus(), 300); } else { el.classList.add('hidden'); } }
    async function enviarMensagemChat() { const input = document.getElementById('chatInput'); const hist = document.getElementById('chatHistory'); const msg = input.value.trim(); if(!msg) return; hist.innerHTML += `<div class="flex gap-3 justify-end fade-in mb-3"><div class="bg-[#004c99] p-3 rounded-2xl rounded-tr-none text-sm text-white shadow-sm max-w-[85%]">${msg}</div></div>`; input.value = ''; const loadId = 'load-' + Date.now(); hist.innerHTML += `<div id="${loadId}" class="flex gap-3 fade-in mb-3"><div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-xs"><i class="fas fa-spinner fa-spin"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none border border-gray-100 text-sm text-gray-400 italic">...</div></div>`; hist.scrollTop = hist.scrollHeight; const resp = await perguntarIABackend(msg); document.getElementById(loadId)?.remove(); if(resp) { const cleanResp = resp.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); hist.innerHTML += `<div class="flex gap-3 fade-in mb-3"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-[#004c99] text-xs"><i class="fas fa-robot"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none border border-gray-100 text-sm text-gray-600 shadow-sm max-w-[90%] leading-relaxed">${cleanResp}</div></div>`; hist.scrollTop = hist.scrollHeight; } }
    function setLoggedUser() { const v = document.getElementById('userSelect').value; if (v) { loggedUser = v; localStorage.setItem('loggedUser', v); initApp(); } else alert('Selecione!'); }
    function logout() { if(confirm("Sair?")) { localStorage.removeItem('loggedUser'); location.reload(); } }
    async function buscarEnderecoGPS() { if (!navigator.geolocation) return alert("GPS desligado."); showLoading(true); navigator.geolocation.getCurrentPosition(async (pos) => { try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`); const data = await res.json(); if (data && data.address) { const elEnd = document.getElementById('leadEndereco'); const elBairro = document.getElementById('leadBairro'); const elCidade = document.getElementById('leadCidade'); if(elEnd) elEnd.value = data.address.road || ''; if(elBairro) elBairro.value = data.address.suburb || data.address.neighbourhood || ''; if(elCidade) elCidade.value = data.address.city || data.address.town || ''; alert(`‚úÖ Localizado: ${data.address.road}`); } } catch (e) { alert("Erro ao obter endere√ßo."); } showLoading(false); }, () => { showLoading(false); alert("Erro no GPS."); }, { enableHighAccuracy: true }); }
    function iniciarDitado(t, b) { const R = window.SpeechRecognition || window.webkitSpeechRecognition; if(!R) return alert("Navegador sem voz"); const r = new R(); r.lang='pt-BR'; r.start(); r.onresult = e => { document.getElementById(t).value += " " + e.results[0][0].transcript; }; }
    </script>
</body>
</html>
