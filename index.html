<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MHNET Gestor V117</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004c99">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/svgs/solid/wifi.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .fade-in { animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        body { height: 100dvh; overscroll-behavior-y: none; background-color: #f8fafc; font-family: sans-serif; }
        
        .input-padrao { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; background: white; color: #333; }
        .input-padrao:focus { border-color: #00aeef; outline: none; }
        .label-padrao { font-size: 11px; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 4px; display: block; }
        
        /* Menu Inferior Fixo */
        .glass-nav { 
            background: white; 
            border-top: 1px solid #eee; 
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        .tag-info { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; background: #f0f9ff; color: #004c99; border: 1px solid #b3e0ff; }
        
        /* Botões de Filtro */
        .filter-btn { padding: 6px 12px; border-radius: 20px; border: 1px solid #ddd; background: white; color: #666; font-size: 11px; font-weight: bold; white-space: nowrap; }
        .filter-btn.active { background: #004c99; color: white; border-color: #004c99; }
    </style>
</head>
<body class="text-slate-800 select-none">

    <!-- LOGIN -->
    <div id="userMenu" class="fixed inset-0 z-[100] bg-[#004c99] flex flex-col items-center justify-center p-8 fade-in">
        <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl text-center">
            <i class="fas fa-wifi text-4xl text-[#004c99] mb-4"></i>
            <h2 class="text-2xl font-bold mb-6 text-[#004c99]">Acesso MHNET</h2>
            
            <select id="userSelect" class="w-full p-4 mb-4 rounded-xl border border-gray-300 text-lg font-bold text-center">
                <option value="">Carregando...</option>
            </select>
            
            <button onclick="if(window.setLoggedUser){window.setLoggedUser()}else{alert('Aguarde...')}" class="w-full bg-[#00aeef] text-white font-bold py-4 rounded-xl shadow-lg active:scale-95">
                ENTRAR
            </button>
            <div onclick="window.location.reload(true)" class="mt-4 text-xs text-gray-400 cursor-pointer">Recarregar</div>
        </div>
        <p class="text-white/40 text-xs mt-8">V117 Restaurada</p>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="mainContent" class="hidden flex-1 flex flex-col h-full relative">
        
        <!-- HEADER -->
        <header class="bg-[#004c99] text-white pt-4 pb-3 px-4 shadow-md flex justify-between items-center z-20 shrink-0 rounded-b-xl">
            <div>
                <h1 class="font-bold text-lg">MHNET</h1>
                <div class="flex items-center gap-2 text-xs opacity-90">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span id="userInfo">...</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="abrirConfiguracoes()" id="btnAdminSettings" class="hidden w-8 h-8 bg-white/20 rounded flex items-center justify-center"><i class="fas fa-cog text-xs"></i></button>
                <button onclick="logout()" class="w-8 h-8 bg-white/20 rounded flex items-center justify-center"><i class="fas fa-power-off text-xs"></i></button>
            </div>
        </header>

        <!-- SCROLL AREA -->
        <main id="main-scroll" class="flex-1 overflow-y-auto p-4 pb-28 no-scrollbar scroll-smooth relative z-10">
            
            <!-- DASHBOARD -->
            <div id="dashboard" class="page fade-in">
                <!-- Admin Panel -->
                <div id="adminPanel" class="hidden bg-slate-800 text-white p-3 rounded-xl mb-4 border-l-4 border-yellow-400 shadow">
                    <p class="text-xs font-bold uppercase text-yellow-400"><i class="fas fa-crown"></i> Painel Gestor</p>
                    <p class="text-xs text-slate-300">Visualizando equipe completa.</p>
                </div>

                <!-- Botões de Atalho -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div onclick="filtrarLeadsHoje()" class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-center active:scale-95">
                        <div id="statLeads" class="text-3xl font-black text-[#004c99]">0</div>
                        <div class="text-xs font-bold text-gray-400 uppercase">Leads Hoje</div>
                    </div>
                    <div onclick="verTodosLeads()" class="bg-blue-600 p-4 rounded-xl shadow-md text-center text-white active:scale-95">
                        <i class="fas fa-address-book text-2xl mb-1"></i>
                        <div class="text-xs font-bold uppercase">Minha Carteira</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button onclick="navegarPara('tarefas')" class="bg-white p-3 rounded-xl shadow-sm border flex flex-col items-center gap-1 active:scale-95">
                        <i class="fas fa-check-square text-indigo-500 text-xl"></i><span class="text-xs font-bold">Tarefas</span>
                    </button>
                    <button onclick="navegarPara('faltas')" class="bg-white p-3 rounded-xl shadow-sm border flex flex-col items-center gap-1 active:scale-95">
                        <i class="fas fa-calendar-times text-red-500 text-xl"></i><span class="text-xs font-bold">Faltas</span>
                    </button>
                </div>

                <button onclick="navegarPara('cadastroLead')" class="w-full bg-[#004c99] text-white p-4 rounded-xl shadow-lg flex items-center justify-between mb-4 active:scale-95">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center"><i class="fas fa-user-plus"></i></div>
                        <div class="text-left"><p class="text-xs opacity-80">Cadastrar</p><p class="font-bold">Novo Cliente</p></div>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </button>

                <!-- Ferramentas -->
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="navegarPara('materiais')" class="bg-white border p-3 rounded-xl flex items-center gap-2 text-xs font-bold text-slate-600 shadow-sm"><i class="fas fa-images text-orange-500 text-lg"></i> Materiais</button>
                    <button onclick="navegarPara('objecoes')" class="bg-white border p-3 rounded-xl flex items-center gap-2 text-xs font-bold text-slate-600 shadow-sm"><i class="fas fa-shield-alt text-red-500 text-lg"></i> Objeções</button>
                    <button onclick="consultarPlanosIA()" class="bg-white border p-3 rounded-xl flex items-center gap-2 text-xs font-bold text-blue-600 shadow-sm"><i class="fas fa-robot text-lg"></i> Chat IA</button>
                    <button onclick="abrirIndicadores()" class="bg-white border p-3 rounded-xl flex items-center gap-2 text-xs font-bold text-green-600 shadow-sm"><i class="fas fa-chart-pie text-lg"></i> Funil</button>
                </div>
            </div>

            <!-- TELA LEADS (CARTEIRA) -->
            <div id="gestaoLeads" class="page hidden fade-in">
                <div class="flex items-center justify-between mb-3">
                    <button onclick="navegarPara('dashboard')" class="text-gray-400 w-8 h-8 rounded-full border flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
                    <h2 class="text-lg font-bold text-[#004c99]">Carteira</h2>
                    <button onclick="carregarLeads(true)" class="text-blue-500 w-8 h-8 rounded-full border flex items-center justify-center"><i class="fas fa-sync"></i></button>
                </div>

                <div class="flex gap-2 overflow-x-auto pb-2 mb-3 no-scrollbar">
                    <button onclick="filtrarPorStatus('Todos')" class="filter-btn active" id="btnFilterTodos">Todos</button>
                    <button onclick="filtrarPorStatus('Novo')" class="filter-btn" id="btnFilterNovo">Novos</button>
                    <button onclick="filtrarPorStatus('Em Negociação')" class="filter-btn" id="btnFilterNegociação">Negociação</button>
                    <button onclick="filtrarPorStatus('Venda Fechada')" class="filter-btn" id="btnFilterVendaFechada">Vendas</button>
                </div>

                <input type="text" id="searchLead" onkeyup="renderLeads()" class="w-full p-2 border rounded-lg mb-3 text-sm" placeholder="Buscar cliente...">
                <div id="listaLeadsGestao" class="space-y-2 pb-20"></div>
            </div>

            <!-- MODAL DETALHES LEAD (AQUI ESTAVA O PROBLEMA) -->
            <div id="leadModal" class="hidden fixed inset-0 z-[60] bg-black/60 flex items-end sm:items-center justify-center">
                <div onclick="fecharLeadModal()" class="absolute inset-0"></div>
                <div class="bg-[#f0f4f8] w-full sm:w-[450px] sm:rounded-xl rounded-t-3xl relative shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
                    
                    <div class="bg-white p-4 sticky top-0 z-10 border-b border-gray-200 rounded-t-3xl">
                        <div class="flex justify-between items-start mb-2">
                            <h3 id="modalLeadNome" class="text-lg font-black text-slate-800 w-3/4">Nome do Lead</h3>
                            <button onclick="fecharLeadModal()" class="text-gray-400 p-2"><i class="fas fa-times text-xl"></i></button>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <span class="tag-info"><i class="fas fa-wifi"></i> <span id="modalLeadProvedor"></span></span>
                            <span class="tag-info"><i class="fab fa-whatsapp"></i> <span id="modalLeadTelefone"></span></span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editarLeadAtual()" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg text-xs font-bold border">EDITAR</button>
                            <button onclick="excluirLead()" class="w-10 bg-red-100 text-red-500 rounded-lg border border-red-200"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>

                    <div class="p-4 space-y-4">
                        <!-- Admin Area -->
                        <div id="adminEncaminharArea" class="hidden bg-yellow-100 p-3 rounded-xl border border-yellow-200">
                            <label class="text-[10px] font-bold text-yellow-800 uppercase mb-1">Encaminhar Lead</label>
                            <div class="flex gap-2"><select id="modalLeadDestino" class="flex-1 input-padrao h-9 py-1 text-xs"></select><button onclick="encaminharLeadModal()" class="bg-yellow-500 text-white w-10 rounded shadow"><i class="fas fa-share"></i></button></div>
                        </div>

                        <!-- Funil -->
                        <div>
                            <label class="label-padrao">Status</label>
                            <select id="modalStatusFunil" class="input-padrao h-12 bg-white font-bold text-slate-700">
                                <option value="Novo">Novo</option>
                                <option value="Em Negociação">Em Negociação</option>
                                <option value="Agendado">Agendado</option>
                                <option value="Venda Fechada">✅ Venda Fechada</option>
                                <option value="Perda">❌ Perda</option>
                            </select>
                        </div>

                        <!-- Agenda -->
                        <div class="bg-orange-50 p-3 rounded-xl border border-orange-200">
                            <label class="label-padrao text-orange-800 mb-1">Agendar Retorno</label>
                            <div class="flex gap-2"><input type="date" id="agendarData" class="flex-1 input-padrao h-10 text-sm"><input type="time" id="agendarHora" class="w-20 input-padrao h-10 text-sm"></div>
                        </div>

                        <!-- Botão Ação -->
                        <button onclick="salvarEdicaoModal()" class="w-full bg-[#004c99] text-white font-bold py-3 rounded-xl shadow-lg text-sm">ATUALIZAR LEAD</button>
                        
                        <div class="grid grid-cols-2 gap-2 mt-2">
                             <button onclick="gerarScriptVendaIA()" class="bg-purple-100 text-purple-700 font-bold py-3 rounded-xl border border-purple-200 text-xs flex items-center justify-center gap-1"><i class="fas fa-magic"></i> Script IA</button>
                             <button id="btnModalWhats" class="bg-green-500 text-white font-bold py-3 rounded-xl shadow text-xs flex items-center justify-center gap-1"><i class="fab fa-whatsapp text-lg"></i> WhatsApp</button>
                        </div>

                        <!-- Obs -->
                        <div>
                            <label class="label-padrao">Observações</label>
                            <textarea id="modalLeadObs" rows="3" class="input-padrao text-sm" placeholder="Anote aqui..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TELA CADASTRO -->
            <div id="cadastroLead" class="page hidden fade-in"><div class="flex items-center gap-4 mb-4"><button onclick="navegarPara('dashboard')" class="text-gray-400"><i class="fas fa-arrow-left text-xl"></i></button><h2 class="text-lg font-bold text-[#004c99]">Cadastro</h2></div><div class="bg-white p-5 rounded-xl shadow-sm space-y-3"><button onclick="buscarEnderecoGPS()" class="w-full bg-blue-50 text-blue-600 font-bold py-3 rounded-lg text-xs flex justify-center gap-2 border border-blue-100"><i class="fas fa-map-marker-alt"></i> GPS LOCAL</button><input type="text" id="leadNome" class="input-padrao" placeholder="Nome *"><input type="tel" id="leadTelefone" class="input-padrao" placeholder="WhatsApp *"><input type="text" id="leadEndereco" class="input-padrao" placeholder="Endereço"><div class="grid grid-cols-2 gap-2"><input type="text" id="leadBairro" class="input-padrao" placeholder="Bairro"><input type="text" id="leadCidade" class="input-padrao" placeholder="Cidade"></div><input type="text" id="leadProvedor" class="input-padrao" placeholder="Provedor Atual"><select id="leadInteresse" class="input-padrao"><option>Alto</option><option selected>Médio</option><option>Baixo</option></select><select id="leadStatus" class="input-padrao"><option value="Novo">Novo</option><option value="Em Negociação">Em Negociação</option></select><div id="divEncaminhar" class="hidden bg-yellow-50 p-3 rounded-xl border border-yellow-200"><label class="label-padrao text-yellow-700">Encaminhar (Admin)</label><select id="leadVendedorDestino" class="input-padrao text-sm"><option value="">Selecione...</option></select></div><textarea id="leadObs" rows="3" class="input-padrao" placeholder="Obs..."></textarea><button onclick="enviarLead()" class="w-full bg-[#00aeef] text-white font-bold py-3 rounded-xl shadow-lg mt-2">SALVAR</button></div></div>
            
            <!-- Outras Telas (Simplificadas para funcionar) -->
            <div id="tarefas" class="page hidden fade-in"><div class="flex justify-between mb-4"><h2 class="font-bold text-[#004c99]">Tarefas</h2><button onclick="abrirModalTarefa()" class="text-blue-600"><i class="fas fa-plus"></i></button></div><div id="listaTarefasContainer" class="space-y-2"></div></div>
            <div id="faltas" class="page hidden fade-in"><h2 class="font-bold text-[#004c99] mb-4">Justificativa</h2><div class="bg-white p-5 rounded-xl shadow-sm space-y-3"><input type="date" id="faltaData" class="input-padrao"><select id="faltaMotivo" class="input-padrao"><option>CONSULTA MÉDICA</option><option>FOLGA PROGRAMADA</option><option>OUTROS</option></select><textarea id="faltaObs" class="input-padrao" placeholder="Obs..."></textarea><button onclick="enviarJustificativa()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">ENVIAR</button></div></div>
            <div id="materiais" class="page hidden fade-in"><h2 class="font-bold text-[#004c99] mb-4">Materiais</h2><div id="materiaisGrid" class="grid grid-cols-2 gap-3"></div></div>
            <div id="indicadores" class="page hidden fade-in"><h2 class="font-bold text-[#004c99] mb-4">Funil</h2><div class="bg-white p-5 rounded-xl text-center"><h3 id="indRealizado" class="text-4xl font-black text-green-500">0</h3><p class="text-xs">Vendas Mês</p></div></div>
            
            <!-- Modais Auxiliares -->
            <div id="configModal" class="hidden fixed inset-0 z-[90] bg-black/80 flex justify-center items-center p-4"><div class="bg-white w-full max-w-sm rounded-xl p-6"><h3 class="font-bold mb-4">Equipe</h3><input id="cfgNomeVendedor" class="input-padrao mb-2" placeholder="Nome"><div class="flex gap-2"><button onclick="gerirEquipe('add')" class="flex-1 bg-green-500 text-white py-2 rounded">Add</button><button onclick="gerirEquipe('remove')" class="flex-1 bg-red-500 text-white py-2 rounded">Rem</button></div><button onclick="document.getElementById('configModal').classList.add('hidden')" class="w-full mt-4 text-xs">Fechar</button></div></div>
            <div id="taskModal" class="hidden fixed inset-0 z-[80] bg-black/60 flex justify-center items-center p-4"><div class="bg-white w-full max-w-sm rounded-xl p-6"><h3 class="font-bold mb-4">Nova Tarefa</h3><input id="taskDesc" class="input-padrao mb-3" placeholder="Descrição"><input type="date" id="taskDate" class="input-padrao mb-3"><select id="taskLeadSelect" class="input-padrao mb-4"></select><button onclick="salvarTarefa()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">SALVAR</button><button onclick="document.getElementById('taskModal').classList.add('hidden')" class="w-full mt-3 text-gray-400">Cancelar</button></div></div>
            <div id="chatModal" class="hidden fixed inset-0 z-50 bg-black/60 flex justify-center items-center p-4"><div class="bg-white w-full max-w-md h-[70vh] rounded-xl flex flex-col"><div class="bg-[#004c99] p-4 text-white font-bold flex justify-between"><span>Chat IA</span><button onclick="toggleChat()"><i class="fas fa-times"></i></button></div><div id="chatHistory" class="flex-1 p-4 overflow-y-auto"></div><div class="p-4 border-t flex gap-2"><input id="chatInput" class="flex-1 input-padrao"><button onclick="enviarMensagemChat()" class="bg-blue-600 text-white w-10 h-10 rounded-full"><i class="fas fa-paper-plane"></i></button></div></div></div>

        </main>

        <!-- MENU INFERIOR FIXO -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-2xl flex justify-around items-center h-16 z-50">
            <button onclick="navegarPara('dashboard')" class="flex flex-col items-center text-gray-400 hover:text-[#00aeef] w-16"><i class="fas fa-home text-xl"></i><span class="text-[10px]">Início</span></button>
            <button onclick="navegarPara('cadastroLead')" class="relative -top-5 bg-[#00aeef] w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg border-4 border-white"><i class="fas fa-plus text-xl"></i></button>
            <button onclick="verTodosLeads()" class="flex flex-col items-center text-gray-400 hover:text-[#00aeef] w-16"><i class="fas fa-address-book text-xl"></i><span class="text-[10px]">Carteira</span></button>
        </nav>

        <!-- LOADER -->
        <div id="loader" class="hidden fixed inset-0 z-[99] bg-white/90 flex flex-col items-center justify-center"><div class="w-12 h-12 border-4 border-blue-200 border-t-[#00aeef] rounded-full animate-spin mb-4"></div><p class="font-bold text-slate-400 text-xs">CARREGANDO</p></div>
    </div>

    <script src="app.js"></script>
    <script>
        // Fallback Login
        window.addEventListener('load', () => { 
            const s = document.getElementById('userSelect');
            if(s && s.options.length <= 1) { 
                setTimeout(() => { 
                    if(s.options.length <= 1) { 
                        const OFF = ["Bruno Garcia Queiroz", "Ana Paula Rodrigues", "Vendedor Teste"];
                        s.innerHTML = '<option value="">Modo Offline (Selecione)</option>' + OFF.map(n => `<option value="${n}">${n}</option>`).join('');
                    }
                }, 3000); 
            }
        });
    </script>
</body>
</html>
